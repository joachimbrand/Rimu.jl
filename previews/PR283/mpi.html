<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using MPI · Rimu.jl</title><meta name="title" content="Using MPI · Rimu.jl"/><meta property="og:title" content="Using MPI · Rimu.jl"/><meta property="twitter:title" content="Using MPI · Rimu.jl"/><meta name="description" content="Documentation for Rimu.jl."/><meta property="og:description" content="Documentation for Rimu.jl."/><meta property="twitter:description" content="Documentation for Rimu.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.png" alt="Rimu.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">Rimu.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="index.html">Guide</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="generated/BHM-example.html">1D Bose-Hubbard Model</a></li><li><a class="tocitem" href="generated/BHM-example-mpi.html">Rimu with MPI</a></li><li><a class="tocitem" href="generated/G2-example.html">Calculating observables</a></li><li><a class="tocitem" href="generated/exact-example.html">Exact diagonalization</a></li><li><a class="tocitem" href="generated/HO-example.html">Degenerate perturbation theory in a harmonic oscillator basis</a></li></ul></li><li><span class="tocitem">User documentation</span><ul><li><a class="tocitem" href="exactdiagonalization.html">Exact Diagonalization</a></li><li><a class="tocitem" href="projectormontecarlo.html">Projector Monte Carlo</a></li><li><a class="tocitem" href="statstools.html">StatsTools</a></li><li class="is-active"><a class="tocitem" href="mpi.html">Using MPI</a><ul class="internal"><li><a class="tocitem" href="#Configuring-MPI"><span>Configuring MPI</span></a></li><li><a class="tocitem" href="#Using-Slurm"><span>Using Slurm</span></a></li><li><a class="tocitem" href="#Common-pitfalls-with-reducing-functions"><span>Common pitfalls with reducing functions</span></a></li><li><a class="tocitem" href="#Threaded-operations-and-reductions"><span>Threaded operations and reductions</span></a></li></ul></li></ul></li><li><span class="tocitem">Developer documentation</span><ul><li><a class="tocitem" href="interfaces.html">Interfaces</a></li><li><a class="tocitem" href="hamiltonians.html">Hamiltonians</a></li><li><a class="tocitem" href="dictvectors.html">Dict vectors</a></li><li><a class="tocitem" href="addresses.html">BitString addresses</a></li><li><a class="tocitem" href="stochasticstyles.html">Stochastic styles</a></li><li><a class="tocitem" href="RMPI.html">RMPI</a></li><li><a class="tocitem" href="rimuio.html">I/O</a></li><li><a class="tocitem" href="randomnumbers.html">Random numbers</a></li><li><a class="tocitem" href="documentation.html">Documentation generation</a></li><li><a class="tocitem" href="testing.html">Code testing</a></li></ul></li><li><a class="tocitem" href="API.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">User documentation</a></li><li class="is-active"><a href="mpi.html">Using MPI</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="mpi.html">Using MPI</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/joachimbrand/Rimu.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/joachimbrand/Rimu.jl/blob/develop/docs/src/mpi.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Working-with-MPI"><a class="docs-heading-anchor" href="#Working-with-MPI">Working with MPI</a><a id="Working-with-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-MPI" title="Permalink"></a></h1><p>If you are using <a href="dictvectors.html#Rimu.DictVectors.PDVec"><code>PDVec</code></a>s to store your vectors, working with MPI should be fairly straightforward. Generally, <a href="dictvectors.html#Rimu.DictVectors.PDVec"><code>PDVec</code></a> will work with MPI automatically, as long as MPI is set up correctly and a few common pitfalls are avoided.</p><p>Rimu includes an unexported module <a href="RMPI.html#Rimu.RMPI"><code>RMPI</code></a>, which must be imported to access additional MPI-related functionality.</p><h2 id="Configuring-MPI"><a class="docs-heading-anchor" href="#Configuring-MPI">Configuring MPI</a><a id="Configuring-MPI-1"></a><a class="docs-heading-anchor-permalink" href="#Configuring-MPI" title="Permalink"></a></h2><p>When running on a cluster, ensure that MPI.jl is using the system binary. See <a href="https://juliaparallel.org/MPI.jl/latest/configuration/">the MPI.jl documentation</a> for more information.</p><p>It is always a good idea to start your script with a quick test that ensures the MPI is set up correctly. One way to do this is to open with</p><pre><code class="language-julia hljs">using Rimu.RMPI
mpi_allprintln(&quot;hello&quot;)</code></pre><p>which should print something like</p><pre><code class="nohighlight hljs">[ rank 0: hello
[ rank 1: hello
[ rank 2: hello
[ rank 3: hello</code></pre><p>If it prints <code>rank 0</code> several times, the code will run, but ranks will not communicate.</p><h2 id="Using-Slurm"><a class="docs-heading-anchor" href="#Using-Slurm">Using Slurm</a><a id="Using-Slurm-1"></a><a class="docs-heading-anchor-permalink" href="#Using-Slurm" title="Permalink"></a></h2><p>When using <a href="dictvectors.html#Rimu.DictVectors.PDVec"><code>PDVec</code></a>, the recommended setup is to use threads to parallelise the computation within a node, and to only use MPI for inter-node communication. In a slurm script, this is done as follows:</p><pre><code class="language-bash hljs">...
#SBATCH --ntasks-per-node=1
#SBATCH --nodes=4            # replace 4 with the desired number of nodes
#SBATCH --cpus-per-task=28   # replace 28 with the number of cores available in a node
#SBATCH --hint=nomultithread # don&#39;t use hyperthreading
...

srun julia --project -tauto script.jl</code></pre><p>On some clusters, additional settings must be used with <code>srun</code>, for example the CTCP cluster requires the following.</p><pre><code class="language-bash hljs">srun mpi=pmi2 julia --project -tauto script.jl</code></pre><h2 id="Common-pitfalls-with-reducing-functions"><a class="docs-heading-anchor" href="#Common-pitfalls-with-reducing-functions">Common pitfalls with reducing functions</a><a id="Common-pitfalls-with-reducing-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Common-pitfalls-with-reducing-functions" title="Permalink"></a></h2><h3 id="Using-@mpi_root"><a class="docs-heading-anchor" href="#Using-@mpi_root">Using <code>@mpi_root</code></a><a id="Using-@mpi_root-1"></a><a class="docs-heading-anchor-permalink" href="#Using-@mpi_root" title="Permalink"></a></h3><p>Take care to not use reducing functions (such as <code>length</code>, <code>sum</code>, <code>norm</code>, ...) inside <a href="RMPI.html#Rimu.RMPI.@mpi_root-Tuple"><code>@mpi_root</code></a> blocks. Doing so will only initiate the distributed reduction on one rank only, which will cause the code to go out of sync and freeze. As an example, to report the current length of a vector, calculate the length before the <a href="RMPI.html#Rimu.RMPI.@mpi_root-Tuple"><code>@mpi_root</code></a> block:</p><pre><code class="language-julia hljs">len = length(pdvec)
@mpi_root println(&quot;vector length is $len&quot;)</code></pre><h2 id="Threaded-operations-and-reductions"><a class="docs-heading-anchor" href="#Threaded-operations-and-reductions">Threaded operations and reductions</a><a id="Threaded-operations-and-reductions-1"></a><a class="docs-heading-anchor-permalink" href="#Threaded-operations-and-reductions" title="Permalink"></a></h2><p>When using functions that take anonymous functions, such as <code>map(!)</code>, <code>sum</code>, or <code>mapreduce</code>, it is important that the anonymous functions passed to them do not perform any MPI-reducing operations (<code>length</code>, <code>norm</code>, <code>sum</code>, etc.). These anonymous functions are executed on multiple threads and initiating MPI communication from multiple threads may cause issues.</p><p>As an example, suppose we want to scale a vector by its length by using <code>map!</code>. The correct way to write this code is as</p><pre><code class="language-julia hljs">len = length(pdvec)
map!(values(pdvec)) do x
	x / len
end</code></pre><p>Similar to the previous example, <code>len</code> is calculated first and not within the body of <code>map!</code>. In this specific case, an even better option is to use the <code>scale!</code> function from <a href="https://github.com/Jutho/VectorInterface.jl">VectorInterface.jl</a>:</p><pre><code class="language-julia hljs">scale!(pdvec, 1 / length(pdvec))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="statstools.html">« StatsTools</a><a class="docs-footer-nextpage" href="interfaces.html">Interfaces »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Friday 27 September 2024 04:05">Friday 27 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
